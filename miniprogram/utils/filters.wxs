var _trimLower = function(s){
  if (s === undefined || s === null) return ''
  var start = 0
  var end = s.length - 1
  var c
  // 左侧去空白: 空格(32) \t(9) \n(10) \r(13)
  while (start <= end) {
    c = s.charCodeAt(start)
    if (c === 32 || c === 9 || c === 10 || c === 13) { start++ } else { break }
  }
  // 右侧去空白
  while (end >= start) {
    c = s.charCodeAt(end)
    if (c === 32 || c === 9 || c === 10 || c === 13) { end-- } else { break }
  }
  return s.slice(start, end + 1).toLowerCase()
}

var isNil = function(v){
  if (v === undefined || v === null) return true
  if (typeof v === 'string') {
    var s = _trimLower(v)
    // 兼容后端把空/None/null/Nan 当作字符串返回的情况
    if (s === '' || s === 'none' || s === 'null' || s === 'nan') return true
  }
  return false
}

module.exports = {
  display: function(v){
    return isNil(v) ? '--' : v
  },
  unit: function(v, u){
    return isNil(v) ? '--' : ('' + v + u)
  },
  firstImage: function(list){
    if (!list || list.length === 0) return ''
    return list[0]
  },
  // 将字段名转换为中文标签，用于展示
  getFieldLabel: function(field){
    if (isNil(field)) return ''
    // 已知字段映射，可按需扩展
    var map = {
      'frame_model': '镜架型号',
      'lens_size': '镜片大小',
      'nose_bridge_width': '鼻梁宽度',
      'temple_length': '镜腿长度',
      'frame_total_length': '镜架总长',
      'frame_height': '镜架高度',
      'weight': '重量',
      'price': '售价',
      'other_info': '其他信息',
      'brand_info': '品牌信息',
      'frame_material': '镜架材料'
    }
    // 兜底：找不到则返回原字段名
    return map[field] || field
  },
  // 将组合 filters 对象格式化为可读字符串
  // 例如 {frame_model:'98044', lens_size:'50'} -> "镜架型号：98044；镜片大小：50"
  formatFilters: function(filters){
    if (!filters) return ''
    // 固定顺序，保证显示一致
    var order = ['frame_model','lens_size','nose_bridge_width','temple_length','frame_total_length','frame_height','weight','price','brand_info','other_info','frame_material']
    var map = {
      'frame_model': '镜架型号',
      'lens_size': '镜片大小',
      'nose_bridge_width': '鼻梁宽度',
      'temple_length': '镜腿长度',
      'frame_total_length': '镜架总长',
      'frame_height': '镜架高度',
      'weight': '重量',
      'price': '售价',
      'other_info': '其他信息',
      'brand_info': '品牌信息',
      'frame_material': '镜架材料'
    }
    var parts = []
    for (var i=0;i<order.length;i++){
      var k = order[i]
      var v = filters[k]
      if (v !== undefined && v !== null && (''+v).trim() !== ''){
        parts.push((map[k]||k) + '：' + v)
      }
    }
    return parts.join('；')
  }
}
