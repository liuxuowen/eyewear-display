<!--index.wxml-->
<wxs src="../../utils/filters.wxs" module="f"></wxs>

<!-- 自定义导航栏（含搜索框） -->
<view class="custom-nav" style="height: {{navBarHeight}}px; padding-top: {{statusBarHeight}}px;">
  <view class="nav-row" style="height: {{navBarHeight}}px; padding-right: {{capsuleRightWidth}}px;">
    <view class="search-box" style="height: {{menuHeight}}px;" bindtap="openSearchPage">
      <input class="search-input" style="height: 100%;" placeholder="{{(require('../../config.js').searchPlaceholder)||'搜索（支持镜架型号，镜架尺寸/总长/高度）'}}" value="{{searchDisplay}}"/>
      <view wx:if="{{searchDisplay}}" class="search-clear" catchtap="clearSearch">清空</view>
    </view>
  </view>
</view>
<!-- 占位，避免内容被导航栏遮挡 -->
<view style="height: {{navHeight}}px;"></view>

<view class="container">
  <!-- 销售分享工具栏 -->
  <view class="sales-toolbar" wx:if="{{isSales}}">
    <button size="mini" type="{{selecting ? 'default' : 'primary'}}" class="{{selecting ? 'btn-cancel' : ''}}" bindtap="toggleSelecting">{{selecting ? '取消' : '选择分享'}}</button>
    <button size="mini" type="primary" open-type="share" wx:if="{{selecting}}" disabled="{{selectedCount<=0}}">打包转发(已选 {{selectedCount}}/10)</button>
  </view>
  <view class="product-list">
    <view class="product-item" wx:for="{{products}}" wx:key="frame_model" bindtap="goToDetail" data-model="{{item.frame_model}}">
      <view class="select-box {{selectedMap[item.frame_model] ? 'on' : ''}}" wx:if="{{selecting}}" catchtap="toggleSelectItem" data-model="{{item.frame_model}}"></view>
      <!-- 在选择模式下，整个图片区域作为选择热点，阻止冒泡以避免进入详情 -->
      <image wx:if="{{selecting}}" class="product-image" src="{{f.firstImage(item.images)}}" mode="aspectFit" catchtap="toggleSelectItem" data-model="{{item.frame_model}}"></image>
      <image wx:else class="product-image" src="{{f.firstImage(item.images)}}" mode="aspectFit"></image>
      <view class="product-info">
        <view class="product-title">
          <text>型号：</text>
          <block wx:if="{{item.hl && item.hl.frame_model}}">
            <block wx:for="{{item.hl.frame_model}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
          </block>
          <block wx:else>
            <text>{{f.display(item.frame_model)}}</text>
          </block>
          <view class="fav-wrap">
            <button class="fav-btn {{favoriteIds[item.frame_model] ? 'fav-on' : ''}}" size="mini" type="default" catchtap="toggleFavorite" data-model="{{item.frame_model}}">{{favoriteIds[item.frame_model] ? '已收藏' : '收藏'}}</button>
          </view>
        </view>
        <view class="product-specs">
          <view>
            <text>镜架尺寸：</text>
            <block wx:if="{{item.hl && item.hl.lens_size}}">
              <block wx:for="{{item.hl.lens_size}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else><text>{{f.unit(item.lens_size, '')}}</text></block>
            <text>-</text>
            <block wx:if="{{item.hl && item.hl.nose_bridge_width}}">
              <block wx:for="{{item.hl.nose_bridge_width}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else><text>{{f.unit(item.nose_bridge_width, '')}}</text></block>
            <text>-</text>
            <block wx:if="{{item.hl && item.hl.temple_length}}">
              <block wx:for="{{item.hl.temple_length}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else><text>{{f.unit(item.temple_length, '')}}</text></block>
          </view>
          <view class="price-row"><text>价格：￥{{f.display(item.price)}}</text></view>
          <view>
            <text>镜架总长：</text>
            <block wx:if="{{item.hl && item.hl.frame_total_length}}">
              <block wx:for="{{item.hl.frame_total_length}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else><text>{{f.unit(item.frame_total_length, '')}}</text></block>
          </view>
          <view>
            <text>镜架高度：</text>
            <block wx:if="{{item.hl && item.hl.frame_height}}">
              <block wx:for="{{item.hl.frame_height}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else><text>{{f.unit(item.frame_height, '')}}</text></block>
          </view>
          <view><text>重量：{{f.unit(item.weight, 'g')}}</text></view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 加载更多 -->
  <view class="load-more" wx:if="{{hasMore && !isLoading}}">
    <text bindtap="loadMore">加载更多</text>
  </view>
  <view class="loading" wx:if="{{isLoading}}">加载中...</view>
  <view class="no-more" wx:if="{{!hasMore && products.length > 0 && !isLoading}}">没有更多了</view>
</view>
<!-- 悬浮客服入口 -->
<button class="float-kf" open-type="contact" session-from="{{kfSessionFrom}}" hover-class="none">
  <image class="float-kf-img" src="../../images/cs.png" mode="aspectFit"></image>
  <!-- 无需文字，使用图标展示 -->
</button>