<!--index.wxml-->
<wxs src="../../utils/filters.wxs" module="f"></wxs>

<!-- 自定义导航栏（含搜索框） -->
<view class="custom-nav" style="height: {{navBarHeight}}px; padding-top: {{statusBarHeight}}px;">
  <view class="nav-row" style="height: {{navBarHeight}}px; padding-right: {{capsuleRightWidth}}px;">
    <view class="search-box" style="height: {{menuHeight}}px;" bindtap="openSearchPage">
      <input class="search-input" style="height: 100%;" placeholder="{{searchPlaceholder}}" value="{{searchDisplay}}"/>
      <view wx:if="{{searchDisplay}}" class="search-clear" catchtap="clearSearch">清空</view>
    </view>
  </view>
</view>
<!-- 占位，避免内容被导航栏遮挡 -->
<view style="height: {{navHeight}}px;"></view>

<view class="container">
  <!-- 销售分享工具栏 -->
  <view class="sales-toolbar" wx:if="{{isSales}}" style="position: sticky; top: {{navHeight}}px; z-index: 1001; background: #fff; border-bottom: 1rpx solid #eee;">
    <block wx:if="{{!selecting}}">
      <button size="mini" type="primary" class="toolbar-btn" bindtap="toggleSelecting">选择分享</button>
    </block>
    <block wx:else>
      <view class="two-btns">
        <button size="mini" type="default" class="toolbar-half" bindtap="toggleSelecting">取消</button>
        <button size="mini" type="primary" class="toolbar-half" disabled="{{selectedCount<=0}}" bindtap="addSelectedToBatch">加入推荐( {{selectedCount}})</button>
      </view>
    </block>
  </view>
  <!-- 当未分配销售时立即展示商品列表（不等角色完全就绪）；若已分配销售则等待 roleReady 再决定是否跳转 -->
  <view class="product-list" wx:if="{{isSales || (!hasMySales)}}">
  <view class="product-item" wx:for="{{products}}" wx:key="frame_model" bindtap="onProductTap" data-model="{{item.frame_model}}">
      <view class="select-box {{selectedMap[item.frame_model] ? 'on' : ''}}" wx:if="{{selecting}}" catchtap="toggleSelectItem" data-model="{{item.frame_model}}"></view>
  <image class="product-image" src="{{f.firstThumb(item.images)}}" mode="aspectFit"></image>
      <view class="product-info">
        <view class="product-title">
          <text>型号：</text>
          <block wx:if="{{item.hl && item.hl.frame_model}}">
            <block wx:for="{{item.hl.frame_model}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
          </block>
          <block wx:else>
            <text>{{f.display(item.frame_model)}}</text>
          </block>
          <!-- 用户侧不再提供“推荐/收藏”入口；推荐数据仅由销售侧生成 -->
        </view>
        <view class="product-specs">
          <view>
            <text>镜架尺寸：</text>
            <block wx:if="{{item.hl && item.hl.lens_size}}">
              <block wx:for="{{item.hl.lens_size}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else><text>{{f.unit(item.lens_size, '')}}</text></block>
            <text>-</text>
            <block wx:if="{{item.hl && item.hl.nose_bridge_width}}">
              <block wx:for="{{item.hl.nose_bridge_width}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else><text>{{f.unit(item.nose_bridge_width, '')}}</text></block>
            <text>-</text>
            <block wx:if="{{item.hl && item.hl.temple_length}}">
              <block wx:for="{{item.hl.temple_length}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else><text>{{f.unit(item.temple_length, '')}}</text></block>
          </view>
          <view class="price-row">
            <text>价格：</text>
            <text>￥</text>
            <block wx:if="{{item.hl && item.hl.price}}">
              <block wx:for="{{item.hl.price}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else>
              <text>{{f.display(item.price)}}</text>
            </block>
          </view>
          <!-- 镜架总长 与 镜架高度 同行展示 -->
          <view class="spec-pair-row">
            <view class="spec-item">
              <text>镜架总长：</text>
              <block wx:if="{{item.hl && item.hl.frame_total_length}}">
                <block wx:for="{{item.hl.frame_total_length}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
              </block>
              <block wx:else><text>{{f.unit(item.frame_total_length, '')}}</text></block>
            </view>
            <view class="spec-item">
              <text>镜架高度：</text>
              <block wx:if="{{item.hl && item.hl.frame_height}}">
                <block wx:for="{{item.hl.frame_height}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
              </block>
              <block wx:else><text>{{f.unit(item.frame_height, '')}}</text></block>
            </view>
          </view>
          
          <!-- 重量 与 材质 同行展示（两列各50%） -->
          <view class="wm-row">
            <view class="weight-col">
              <text>重量：</text>
              <block wx:if="{{item.hl && item.hl.weight}}">
                <block wx:for="{{item.hl.weight}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
                <text>g</text>
              </block>
              <block wx:else>
                <text>{{f.unit(item.weight, 'g')}}</text>
              </block>
            </view>
            <view class="material-col">
              <text class="mat-label">材质：</text>
              <block wx:if="{{item.mats && item.mats.length}}">
                <view class="mat-tags">
                  <block wx:if="{{item.hl && item.hl.material_tokens}}">
                    <block wx:for="{{item.hl.material_tokens}}" wx:for-item="mt" wx:key="index">
                      <view class="tag-chip {{mt.highlight ? 'on' : ''}}">{{mt.text}}</view>
                    </block>
                  </block>
                  <block wx:else>
                    <block wx:for="{{item.mats}}" wx:for-item="mat" wx:key="*this">
                      <view class="tag-chip">{{mat}}</view>
                    </block>
                  </block>
                </view>
              </block>
              <block wx:else>
                <text class="mat-none">--</text>
              </block>
            </view>
          </view>
          <!-- 品牌展示（始终展示，无内容显示 --） -->
          <view>
            <text>品牌：</text>
            <block wx:if="{{item.hl && item.hl.brand}}">
              <block wx:for="{{item.hl.brand}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else>
              <text>{{item.brand_text || '--'}}</text>
            </block>
          </view>
          
          <view>
            <text>其他信息：</text>
            <block wx:if="{{item.hl && item.hl.other_info_notes}}">
              <block wx:for="{{item.hl.other_info_notes}}" wx:for-item="seg" wx:key="index"><text class="{{seg.highlight ? 'hl' : ''}}">{{seg.text}}</text></block>
            </block>
            <block wx:else>
              <text>{{item.notes_text || '--'}}</text>
            </block>
          </view>
          
        </view>
      </view>
    </view>
  </view>
  
  <!-- 加载更多 -->
  <view class="load-more" wx:if="{{(isSales || (!hasMySales)) && hasMore && !isLoading}}">
    <text bindtap="loadMore">加载更多</text>
  </view>
  <view class="loading" wx:if="{{(isSales || (!hasMySales)) && isLoading}}">加载中...</view>
  <view class="no-more" wx:if="{{(isSales || (!hasMySales)) && !hasMore && products.length > 0 && !isLoading}}">没有更多了</view>

  <!-- 预留底部空间，避免内容被自定义 tabBar 遮挡 -->
  <view class="tabbar-spacer"></view>
</view>
<!-- 悬浮客服入口 -->
<button class="float-kf" open-type="contact" session-from="{{kfSessionFrom}}" hover-class="none">
  <image class="float-kf-img" src="../../images/cs.png" mode="aspectFit"></image>
  <!-- 无需文字，使用图标展示 -->
</button>