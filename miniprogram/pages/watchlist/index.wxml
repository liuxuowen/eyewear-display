<!--pages/watchlist/index.wxml-->
<wxs src="../../utils/filters.wxs" module="f"></wxs>
<view class="container">
	<!-- 顶部标题 + 清空（销售） -->
	<view class="watchlist-header" wx:if="{{!empty}}">
		<text class="wl-count">已推荐共 {{totalCount}} 款镜架</text>
		<button wx:if="{{isSales}}" size="mini" class="action-btn danger-btn" bindtap="clearAllFavorites">一键清空推荐</button>
	</view>

	<!-- 销售备注 + 一键打包转发（第二行） -->
	<view wx:if="{{isSales && !empty}}" class="share-row">
		<input class="note-input" placeholder="备注(可选，0-10字)" maxlength="10" value="{{salesShareNote}}" bindinput="onNoteInput"/>
		<button size="mini" class="action-btn success-btn" open-type="share" bindtap="prepareShareAllPackage">一键打包转发</button>
	</view>

	<view wx:if="{{empty}}" class="empty">
		<block wx:if="{{isSales}}">
			推荐列表为空，请返回商品页添加推荐商品
		</block>
		<block wx:elif="{{hasMySales}}">
			尚无推荐，请联系销售 <text class="sales-name">{{mySalesName || '您的销售'}}</text>
		</block>
		<block wx:else>
			尚无推荐，请联系客服
			<button class="kf-btn" size="mini" open-type="contact" session-from="sal:自然|ref:自然" hover-class="none">联系客服</button>
		</block>
	</view>

	<!-- 推荐列表分批次布局 -->
	<view wx:else>
		<block wx:for="{{batches}}" wx:key="batch_id" wx:for-index="bidx" wx:for-item="batch">
			<view class="batch-header">
				<text class="batch-title">推荐批次</text>
				<text class="batch-time">{{batch.batch_time || '历史推荐'}}</text>
			</view>
			<block wx:for="{{batch.items}}" wx:key="frame_model" wx:for-item="item">
				<view class="rec-card">
					<view class="rec-model {{bidx == 0 ? 'latest' : 'old'}}">{{item.frame_model}}</view>
					<view class="rec-line">镜架尺寸：{{f.unit(item.lens_size, '')}}-{{f.unit(item.nose_bridge_width, '')}}-{{f.unit(item.temple_length, '')}}</view>
					<view class="rec-line">镜架总长：{{f.unit(item.frame_total_length, '')}}</view>
					<view class="rec-line">镜架高度：{{f.unit(item.frame_height, '')}}</view>
					<view class="rec-images" wx:if="{{item.images && item.images.length}}">
						<block wx:for="{{item.images}}" wx:for-item="img" wx:key="*this">
							<image class="rec-img {{imageLoadedMap[img] ? 'loaded' : ''}}" src="{{imageSrcMap[img] || f.thumb(img)}}" mode="aspectFit" lazy-load="true" bindtap="previewImage" binderror="onImageError" bindload="onImageLoad" data-img="{{img}}" data-current="{{img}}" data-list="{{item.images}}"></image>
						</block>
					</view>
					<view class="rec-actions">
						<button wx:if="{{isSales}}" class="fav-btn fav-on" size="mini" type="default" catchtap="removeFavorite" data-model="{{item.frame_model}}">移出推荐</button>
					</view>
				</view>
			</block>
		</block>

		<view class="loading" wx:if="{{isLoading}}">加载中...</view>
	</view>

	<!-- 预留底部空间，避免内容被自定义 tabBar 遮挡 -->
	<view class="tabbar-spacer"></view>
</view>