# Eyewear - Nginx reverse proxy + HTTPS
# Domain: yimuliaoran.top
# Backend: http://127.0.0.1:5000
# WebSocket upgrade helper
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  listen [::]:80;
  server_name yimuliaoran.top;

  # 强制跳转到 HTTPS
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name yimuliaoran.top;

  # 证书（由 certbot 管理）
  ssl_certificate /etc/letsencrypt/live/yimuliaoran.top-0001/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/yimuliaoran.top-0001/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

  # 基础优化
  server_tokens off;
  client_max_body_size 10m;
  keepalive_timeout 65;
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  # Gzip（可选）
  gzip on;
  gzip_types
    text/plain text/css text/javascript application/javascript application/x-javascript
    application/json application/xml application/rss+xml image/svg+xml;

  # HSTS（配合后端 ProxyFix，一并开启）
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

  # 静态头像直出（高性能）
  location /static/avatars/ {
    alias /opt/projects/backend/static/avatars/;
    autoindex off;
    add_header Cache-Control "public, max-age=2592000, immutable"; # 30天
    try_files $uri =404;
  }

  # -----------------------------
  # 静态图片直出（与后端 .env 的 IMAGE_SAVE_DIR & IMAGE_URL_PREFIX 对齐）
  # IMAGE_URL_PREFIX = https://yimuliaoran.top/static/images/
  # IMAGE_SAVE_DIR   = /var/www/resource/products_img
  # -----------------------------
  location /static/images/ {
    alias /var/www/resource/products_img/;
    autoindex off;
    access_log off;
    gzip off;      # 二进制通常不压缩
    aio off;
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # 健康检查（直通后端）
  location = /healthz {
    proxy_pass http://127.0.0.1:5000/healthz;   # 若后端在 5000 改成 :5000
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # API 反向代理
  # 重要：proxy_pass 不要以 / 结尾，这样可保留 /api 前缀，后端路由与 Flask 完全一致
  location /api/ {
    proxy_pass http://127.0.0.1:5000;          # 若后端在 5000 改成 :5000
    proxy_redirect off;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    proxy_read_timeout 60s;
    proxy_send_timeout 60s;
  }
  
  # .well-known/teo-verification/ 直出
  location ^~ /.well-known/teo-verification/ {
    alias /var/www/.well-known/teo-verification/;
    default_type text/plain;
    autoindex off;
    try_files $uri =404;
  }

  # 404 for /
  location / {
    return 404;
  }

}

